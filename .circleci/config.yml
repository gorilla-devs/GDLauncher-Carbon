version: 2.1

orbs:
  win: circleci/windows@5.0
  node: circleci/node@5.0.2

executors:
  linux:
    docker:
      - image: cimg/rust:1.68.2-browsers
    resource_class: large
  website:
    docker:
      - image: cimg/rust:1.68.2-node
    resource_class: small
  mac:
    macos:
      xcode: "14.2.0"
    resource_class: macos.x86.medium.gen2
  macm1:
    macos:
      xcode: "14.2.0"
    resource_class: macos.x86.medium.gen2

jobs:
  buildMac:
    parameters:
      os:
        type: string
    executor: <<parameters.os>>
    steps:
      - checkout
      - run: git submodule update --init --recursive
      # MACOS
      - when:
          condition:
            and:
              - equal: ["mac", <<parameters.os>>]
          steps:
            - run: |
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=1.68.2
                source "$HOME/.cargo/env"
            - run: |
                node -v

                cargo --version
            - run: |
                echo "" > crates/carbon_app/src/db.rs
                cargo fmt --check
            - run: |
                npm run sudo-init
                chmod -R a+x node_modules
            - run:
                command: pnpm codegen
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm build:mac-x64
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm lint
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm test
                environment:
                  # RUSTFLAGS: -D warnings
            - when:
                condition:
                  and:
                    - equal: ["release", << pipeline.git.branch >>]
                steps:
                  - run:
                      name: "Upload debug info to sentry"
                      command: |
                        cd ./target/x86_64-apple-darwin/production
                        npx @sentry/cli login --auth-token $SENTRY_AUTH_TOKEN
                        npx @sentry/cli difutil check core_module.dSYM/Contents/Resources/DWARF/core_module
                        npx @sentry/cli upload-dif --org gorilladevs-inc --project gdlauncher-app-core core_module.dSYM/Contents/Resources/DWARF/core_module
            - run: cd apps && cd desktop && pnpm clean
            - store_artifacts:
                path: ./apps/desktop/release
      # MACOS M1
      - when:
          condition:
            and:
              - equal: ["macm1", <<parameters.os>>]
          steps:
            - run: |
                curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=1.68.2
                source "$HOME/.cargo/env"
                rustup target add aarch64-apple-darwin
            - run: |
                node -v

                cargo --version
            - run: |
                echo "" > crates/carbon_app/src/db.rs
                cargo fmt --check
            - run: |
                npm run sudo-init
                chmod -R a+x node_modules
            - run:
                command: pnpm codegen
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm build:mac-arm64
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm lint
                environment:
                  # RUSTFLAGS: -D warnings
            - run:
                command: pnpm test
                environment:
                  # RUSTFLAGS: -D warnings
            - when:
                condition:
                  and:
                    - equal: ["release", << pipeline.git.branch >>]
                steps:
                  - run:
                      name: "Upload debug info to sentry"
                      command: |
                        cd ./target/aarch64-apple-darwin/production
                        npx @sentry/cli login --auth-token $SENTRY_AUTH_TOKEN
                        npx @sentry/cli difutil check core_module.dSYM/Contents/Resources/DWARF/core_module
                        npx @sentry/cli upload-dif --org gorilladevs-inc --project gdlauncher-app-core core_module.dSYM/Contents/Resources/DWARF/core_module
            - run: cd apps && cd desktop && pnpm clean
            - store_artifacts:
                path: ./apps/desktop/release
  buildWin:
    working_directory: ./
    executor:
      name: win/default
      size: large
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run:
          name: Install NVM
          shell: powershell.exe
          command: choco install nvm -y
      - run:
          name: Install Node 18.12.1
          shell: powershell.exe
          command: |
            nvm list
            nvm install 18.12.1
            nvm use 18.12.1
      - run:
          name: "Install Rust"
          shell: powershell.exe
          command: |
            $ProgressPreference = 'Continue'
            Invoke-WebRequest -Uri "https://win.rustup.rs/" -OutFile "C:\rustup-init.exe"
            & C:\rustup-init.exe -y --no-modify-path --default-toolchain=1.68.2
            $env:path += ";$env:userprofile\.cargo\bin"

            rustc -Vv
            node -v
            cargo --version
            rustc --version | Out-File -FilePath "rust-version"
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            echo "" > crates/carbon_app/src/db.rs
            cargo fmt --check
          shell: bash.exe
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            npm run init
          shell: bash.exe
      - run:
          command: chmod -R a+x node_modules
          shell: bash.exe
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            pnpm codegen
          shell: bash.exe
          environment:
            CARGO_NET_GIT_FETCH_WITH_CLI: "true"
            # RUSTFLAGS: -D warnings
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            pnpm build:win-x64
          shell: bash.exe
          environment:
            CARGO_NET_GIT_FETCH_WITH_CLI: "true"
            # RUSTFLAGS: -D warnings
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            pnpm lint
          shell: bash.exe
          environment:
            CARGO_NET_GIT_FETCH_WITH_CLI: "true"
            # RUSTFLAGS: -D warnings
      - run:
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            pnpm test
          shell: bash.exe
          environment:
            CARGO_NET_GIT_FETCH_WITH_CLI: "true"
            # RUSTFLAGS: -D warnings
      - when:
          condition:
            and:
              - equal: ["release", << pipeline.git.branch >>]
          steps:
            - run:
                name: "Upload debug info to sentry"
                shell: bash.exe
                command: |
                  export PATH="$HOME/.cargo/bin:$PATH"
                  npm install -g @sentry/cli
                  cd ./target/x86_64-pc-windows-msvc/production
                  sentry-cli login --auth-token $SENTRY_AUTH_TOKEN
                  sentry-cli difutil check core_module.pdb
                  sentry-cli upload-dif --org gorilladevs-inc --project gdlauncher-app-core core_module.pdb
      - run:
          command: cd apps && cd desktop && pnpm clean
          shell: bash.exe
      - store_artifacts:
          path: ./apps/desktop/release
  testDocker:
    executor: "linux"
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run: |
          node -v

          cargo --version
      - run: |
          echo "" > crates/carbon_app/src/db.rs
          cargo fmt --check
      - run: |
          npm run sudo-init
          chmod -R a+x node_modules
      - run:
          command: pnpm codegen
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: IS_DOCKER_TEST=true pnpm build:linux-x64
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm lint
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm test
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm check-bundle
          environment:
            # RUSTFLAGS: -D warnings
      - run: cd apps && cd desktop && pnpm clean
  buildLinux:
    executor: "linux"
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run: |
          node -v

          cargo --version
      - run: |
          echo "" > crates/carbon_app/src/db.rs
          cargo fmt --check
      - run: |
          npm run sudo-init
          chmod -R a+x node_modules
      - run:
          command: pnpm codegen
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm build:linux-x64
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm lint
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          command: pnpm test
          environment:
            # RUSTFLAGS: -D warnings
      - run:
          name: "Upload debug info to sentry"
          command: |
            npm install -g @sentry/cli
            cd ./target/x86_64-unknown-linux-gnu/release
            sudo sentry-cli login --auth-token $SENTRY_AUTH_TOKEN
            sudo sentry-cli difutil check core_module.debug
            sudo sentry-cli upload-dif --org gorilladevs-inc --project gdlauncher-app-core core_module.debug
      - run: cd apps && cd desktop && pnpm clean
      - store_artifacts:
          path: ./apps/desktop/release
workflows:
  every-commit:
    jobs:
      - buildWebsite
      - testDocker:
          filters:
            branches:
              ignore:
                - release
                - develop
  master-develop-builds:
    jobs:
      - buildMac:
          filters:
            branches:
              only:
                - release
                - develop
          matrix:
            parameters:
              os: ["mac", "macm1"]
      - buildWin:
          filters:
            branches:
              only:
                - release
                - develop
      - buildLinux:
          filters:
            branches:
              only:
                - release
                - develop
